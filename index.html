#!/bin/bash

# Define the path to the token file
TOKEN_FILE="./token.txt"

# Check if the token file exists
if [ ! -f "$TOKEN_FILE" ]; then
    echo "Error: Token file '$TOKEN_FILE' not found."
    echo "Please create a 'token.txt' file in the same directory containing your authorization token."
    exit 1
fi

# Read the token from the file and remove any trailing newlines or carriage returns
TOKEN=$(cat "$TOKEN_FILE" | tr -d '\n\r')

# Check if the token is empty (after stripping newlines)
if [ -z "$TOKEN" ]; then
    echo "Error: Token is empty after reading from '$TOKEN_FILE'. Please ensure your authorization token is present and correctly formatted in the file."
    exit 1
fi

# Base API endpoint for listing ALL projects
BASE_API_URL="https://api-gw.platform.linuxfoundation.org/project-service/v1/projects"

# Pagination parameters
PAGE_SIZE=100 # Adjust this based on API's maximum or recommended page size
OFFSET=0     # Start with offset 0

# Initialize project counter for projects that will be displayed in HTML
PROJECTS_LISTED_COUNT=0

echo "Fetching projects, filtering, sorting, and generating HTML..."
echo "--------------------------------------------------------------------------"

# Define a jq function for custom category sorting order AND filtering
# This function defines the logic for sorting and selecting categories for the HTML output.
JQ_HTML_PROCESSOR='
# Assigns a numerical rank to categories for custom sorting.
# Categories not listed here will receive rank 0, meaning they will be filtered out.
def category_rank:
  if .Category == "TAG" then 1
  elif .Category == "Graduated" then 2
  elif .Category == "Incubating" then 3 # Note: "Incubating" used based on previous API response
  elif .Category == "Sandbox" then 4
  else 0 # Projects with other categories or no category will be filtered out.
  end;

# Process the stream of project JSON objects:
# 1. Slurp all incoming JSON objects into a single array.
# 2. Add a temporary sort key based on the category_rank function.
# 3. Filter out projects whose category rank is 0 (i.e., not one of the desired categories).
# 4. Sort the remaining projects first by the custom category rank, then alphabetically by Name.
# 5. Group the sorted projects by their original Category to create the HTML headings.
# 6. Crucially, sort these groups themselves by the category rank of their first element.
# 7. Map each category group to its HTML representation (h2 and ul/li elements).
# 8. Concatenate all generated HTML strings.
[inputs] | # Slurp all incoming JSON objects into an array
map(. + {category_sort_key: category_rank}) | # Add sort key to each object
map(select(.category_sort_key > 0)) | # Filter out projects not in desired categories
sort_by([.category_sort_key, .Name]) | # Sort by custom category order and then by Name
group_by(.Category) | # Group projects by their Category

sort_by(.[0].category_sort_key) | # Sort the groups themselves by the category rank

# Iterate through each category group to build the HTML structure
map(
    # Get the category name for the heading (guaranteed to be one of the four due to filtering)
    (.[0].Category) as $current_category_name |

    # Start the HTML for this category group (h2 and ul)
    "<h2>" + $current_category_name + "</h2>\n<ul class=\"project-list\">\n" + # Added class for JS filtering

    # Iterate through projects within this specific category group (li elements)
    (map(
        # Generate an HTML list item for each project with logo, calendar link, and code link
        # FIX: Corrected the logic for ProjectLogo fallback using `select(length > 0)` and `//`
        "<li class=\"project-item\"><img src=\"" + ((.ProjectLogo | select(length > 0)) // "https://lf-master-project-logos-prod.s3.us-east-2.amazonaws.com/cncf.svg") + "\" alt=\"" + .Name + " Logo\" class=\"project-logo\"> " + .Name + " (<a href=\"https://zoom-lfx.platform.linuxfoundation.org/meetings/" + (.Slug | @uri) + "\">Project calendar</a>)" +
        # Conditionally add "Project code" link if RepositoryURL exists and is not empty
        (if .RepositoryURL and (.RepositoryURL | length > 0) then " (<a href=\"" + .RepositoryURL + "\">Project code</a>)" else "" end) +
        "</li>\n"
    ) | add) + # 'add' concatenates all <li> strings

    "</ul>\n" # Close the unordered list for this category
) | add # 'add' concatenates all the category HTML blocks
'

# Start the HTML file and pipe all collected JSON into jq for final processing
OUTPUT_HTML_FILE="index.html"
{
    # Print the HTML header, the new CNCF calendar entry, and the search box
    cat <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>CNCF Projects</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f7f6; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; font-size: 2.5em; padding-bottom: 10px; border-bottom: 3px solid #3498db;}
        h2 { color: #34495e; border-bottom: 1px solid #bdc3c7; padding-bottom: 8px; margin-top: 30px; font-size: 1.8em; }
        ul { list-style-type: none; padding: 0; margin-left: 20px; }
        li { margin-bottom: 12px; font-size: 1.1em; background-color: #ffffff; padding: 10px 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; color: #2980b9; }
        #search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; /* Include padding in width */
            font-size: 1.1em;
        }
        /* Style for project logos */
        .project-logo {
            width: 110px;  /* Set fixed width for project logos */
            height: 110px; /* Set fixed height for project logos */
            vertical-align: middle; /* Align with text */
            margin-right: 8px; /* Space between logo and text */
            object-fit: contain; /* Ensure image fits within bounds without cropping */
        }
    </style>
</head>
<body>
    <h1>CNCF Project Calendars</h1>

    <h2>Main Calendars</h2>
    <ul>
        <li><img src="https://lf-master-project-logos-prod.s3.us-east-2.amazonaws.com/cncf.svg" alt="CNCF Logo" width="200" height="200" style="vertical-align: middle; margin-right: 8px; object-fit: contain;"> CNCF Main calendar (<a href="https://zoom-lfx.platform.linuxfoundation.org/meetings/cncf">Project calendar</a>)</li>
    </ul>

    <input type="text" id="search-box" onkeyup="filterProjects()" placeholder="Search for projects...">

    <script>
        function filterProjects() {
            let input = document.getElementById('search-box');
            let filter = input.value.toUpperCase();
            let projectLists = document.getElementsByClassName('project-list'); // Get all <ul> with this class

            for (let i = 0; i < projectLists.length; i++) {
                let ul = projectLists[i];
                let li = ul.getElementsByClassName('project-item'); // Get all <li> within this <ul>

                let categoryHasVisibleProjects = false;

                for (let j = 0; j < li.length; j++) {
                    let projectItem = li[j];
                    let textValue = projectItem.textContent || projectItem.innerText;
                    if (textValue.toUpperCase().indexOf(filter) > -1) {
                        projectItem.style.display = ""; // Show the project item
                        categoryHasVisibleProjects = true;
                    } else {
                        projectItem.style.display = "none"; // Hide the project item
                    }
                }

                // Show/hide category heading (h2) based on whether any projects are visible in its list
                let h2 = ul.previousElementSibling; // h2 is the element right before the ul
                if (h2 && h2.tagName === 'H2') {
                    if (categoryHasVisibleProjects) {
                        h2.style.display = "";
                    } else {
                        h2.style.display = "none";
                    }
                }
            }
        }
    </script>

EOF

    # Loop to fetch data page by page
    while true; do
        # Construct the URL with offset and limit (pageSize) parameters
        CURRENT_API_URL="${BASE_API_URL}?offset=${OFFSET}&limit=${PAGE_SIZE}"

        # Fetch data for the current page
        RESPONSE=$(curl -sS -H "Authorization: Bearer $TOKEN" "$CURRENT_API_URL")

        # Basic error check for API response
        if ! echo "$RESPONSE" | jq -e '.Data' > /dev/null 2>&1; then
            echo "Error: Invalid JSON response or 'Data' array not found for offset $OFFSET. Stopping." >&2
            break
        fi

        # Get count of projects on the current API page
        PROJECTS_RECEIVED_ON_PAGE=$(echo "$RESPONSE" | jq '.Data | length')

        # If no projects received, we've reached the end of pagination
        if [ "$PROJECTS_RECEIVED_ON_PAGE" -eq 0 ]; then
            break
        fi

        # Filter projects by Foundation ID and extract desired fields, including ProjectLogo and RepositoryURL.
        FILTERED_JSON_STREAM=$(echo "$RESPONSE" | jq -c '.Data[] | select(.Foundation.ID == "a0941000002wBz4AAE") | {Name: .Name, Slug: .Slug, Category: .Category, ProjectLogo: .ProjectLogo, RepositoryURL: .RepositoryURL}')
        echo "$FILTERED_JSON_STREAM"

        # Update the total count of projects that passed the *initial* filter (Foundation ID)
        # This count reflects all projects sent to the HTML generator, regardless of category.
        CURRENT_PAGE_FILTERED_COUNT=$(echo "$FILTERED_JSON_STREAM" | wc -l)
        PROJECTS_LISTED_COUNT=$((PROJECTS_LISTED_COUNT + CURRENT_PAGE_FILTERED_COUNT))

        # Increment offset for the next API call
        OFFSET=$((OFFSET + PROJECTS_RECEIVED_ON_PAGE))

        # Small delay to respect API rate limits
        sleep 0.2
    done |
    # Pipe ALL collected JSON objects (filtered by Foundation ID) to the final jq command.
    # This jq command will apply the category filtering/sorting and generate the HTML body content.
    jq -n -r "$JQ_HTML_PROCESSOR"

    # Print the HTML footer
    cat <<EOF
</body>
</html>
EOF
} > "$OUTPUT_HTML_FILE" # Redirect all output of this block to the HTML file

echo "--------------------------------------------------------------------------"
echo "Finished fetching projects and generating HTML."
echo "Total projects matching Foundation ID filter (before category filtering for HTML): $PROJECTS_LISTED_COUNT"
echo "HTML file generated: $OUTPUT_HTML_FILE"
